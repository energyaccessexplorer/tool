#!/bin/sh

# This script reads ./dependencies.tsv and fetches the entries in the
# second column into the first column. A poor man's package manager if
# you will...

if [ ! -f dependencies.tsv ]; then
	>&2 echo "No 'dependencies.tsv' file"
	exit 1
fi

if [ -z $DEST ]; then
	>&2 echo "DEST is not defined."
	exit 1
fi

if [ ! -d $DEST ]; then
	printf "%s\n\n" "Creating $DEST..."
	mkdir -p $DEST
fi

function printline {
	echo -en "\e[1A"
	echo -e "\e[0K\r$1"
}

function fetch {
	if curl --location \
			--silent \
			--fail \
			--output \
			"$DEST/$1" "$2"; then
		printline "$1"
	else
		printf "%s\n\n" "FAILED to fetch $1!"
	fi
}

while read -r line
do
	IFS=' ' read target origin <<EOF
`echo $line`
EOF
	printline "Fetching $origin"

	if [ -z "$origin" ]; then
		>&2 echo "Could not parse line: '$line'. Skip."
		exit 1
	fi

	if [ -f "$DEST/$target" ]; then
		printline "$target exists. Skip."
		continue
	fi

	fetch "$target" "$origin"
done <dependencies.tsv

printline "deps finished"
